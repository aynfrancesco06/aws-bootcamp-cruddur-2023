# Week 4 â€” Postgres and RDS


### 1. Create RDS Postgres Instance
  
  I've used the prescribed code snippet for provisioning an RDS instance via AWS CLI, this is doable also via the AWS RDS GUI. This code snippet is from the AWS documentation here [link](https://docs.aws.amazon.com/cli/latest/reference/rds/)

```
aws rds create-db-instance \
  --db-instance-identifier cruddur-db-instance \
  --db-instance-class db.t3.micro \
  --engine postgres \
  --engine-version  14.6 \
  --master-username cruddurroot \
  --master-user-password <yourpassword> \
  --allocated-storage 20 \
  --availability-zone us-east-1a \
  --backup-retention-period 0 \
  --port 5432 \
  --no-multi-az \
  --db-name cruddur \
  --storage-type gp2 \
  --publicly-accessible \
  --storage-encrypted \
  --enable-performance-insights \
  --performance-insights-retention-period 7 \
  --no-deletion-protection 

```

- This code will be pasted in the terminal on your Gitpod Codespace. Other part of the code snippet like '**master-username**' and '**master-user-password**' will be different.

- engine-version refers to the version of the database will be used. In this case, we will use postgres 14.6 version.
- availability zone should be set to where you usually provision resources. In my case its use-east-1a
- no multi az to save costs
- storage encrypted for security

After inputting this code. The result will be shown in your AWS RDS. 

![image](https://user-images.githubusercontent.com/56792014/226118774-25c6b74c-0628-4e50-8a43-3cbee71436c8.png)


If the RDS instance is not being used. We can temporarily stop the instance to avoid going beyond the Free Tier and incurring costs.
  
![image](https://user-images.githubusercontent.com/56792014/226118934-525a40ca-b48f-4703-a939-b9dbc4299e09.png)

- We will run the docker compose file and verify that postgre is running on docker properly.


### 2. Create bash scripts for easier DB deployment (either prod or local)

- In the backend flask, we've created a bin folder that will contain all the bash scripts that we will be using for our database actions.
- We will also create a schema.sql where we will load/unload the database. This is created in a folder called db inside the backend-flask folder.
- I've also created a URL connection string to save time from inputting the database credentials again and again. Then run this commands as ENV VAR. Prod connection will be derived from the endpoint generated by the RDS instance. Instead of **@localhost:5432/cruddur**, this endpoint will be used @cruddur-db-instance.cyirdhpwucb7.us-east-1.rds.amazonaws.com:5432/cruddur.

    - export CONNECTION_URL="postgresql://postgres:password@localhost:5432/cruddur"
    - gp env CONNECTION_URL="postgresql://postgres:password@localhost:5432/cruddur"
    - export PROD_CONNECTION_URL="postgresql://<username>:<prodpassword>@cruddur-db-instance.cyirdhpwucb7.us-east-1.rds.amazonaws.com:5432/cruddur"
    - gp env PROD_CONNECTION_URL="postgresql://<username>:<prodpassword>@cruddur-db-instance.cyirdhpwucb7.us-east-1.rds.amazonaws.com:5432/cruddur"
   

```
postgresql://[user[:password]@][netloc][:port][/dbname][?param1=value1&...]
```

  
![image](https://user-images.githubusercontent.com/56792014/226120733-7f464cf2-0aac-481a-bcf4-6769ca2901d9.png)

**schema.sql**
- It is good practice to obscure as much details that we have on our database, so in this case there's a need to use an extension called **uuid-ossp**. This allows us to mask the sequential numerical identifier on users with random generated characters called UUID.
- The command to import will be used on the backend directory.  It means that we will dump the contents of db/schema.sql to cruddur db inside the psql client

```
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
DROP TABLE IF EXISTS public.users;
DROP TABLE IF EXISTS public.activities;


CREATE TABLE public.users (
  uuid UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  display_name text NOT NULL,
  handle text NOT NULL,
  email text NOT NULL,
  cognito_user_id text NOT NULL,
  created_at TIMESTAMP default current_timestamp NOT NULL
);

CREATE TABLE public.activities (
  uuid UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_uuid UUID NOT NULL,
  message text NOT NULL,
  replies_count integer DEFAULT 0,
  reposts_count integer DEFAULT 0,
  likes_count integer DEFAULT 0,
  reply_to_activity_uuid integer,
  expires_at TIMESTAMP,
  created_at TIMESTAMP default current_timestamp NOT NULL
);
```


**db-connect.sh**
- Running this bash script will enable us to connect to either prod ( AWS RDS ) or local. Add 'prod' at the end when running the script. i.e(./bin/db-connect prod)

```
#! /usr/bin/bash

if [ "$1" = "prod" ]; then
    echo " Running in prod mode"
    URL=$PROD_CONNECTION_URL
else 
    URL=$CONNECTION_URL
fi


psql $URL
```

**db-create.sh**
- Running this bash script will allow us to create a database inside our postgre
```
#! /usr/bin/bash

CYAN='\033[1;36m'
NO_COLOR='\033[0m'
LABEL="db-create"
printf "${CYAN}== ${LABEL}${NO_COLOR}\n"

echo 'db-create'

NO_DB_CONNECTION_URL=$(sed 's/\/cruddur//g' <<<"$CONNECTION_URL")
psql $NO_DB_CONNECTION_URL -c "create database cruddur;"
```

**db-drop.sh**
- Running this bash script will drop/delete the database which in this case is named 'cruddur'
```
#! /usr/bin/bash

CYAN='\033[1;36m'
NO_COLOR='\033[0m'
LABEL="db-drop"
printf "${CYAN}== ${LABEL}${NO_COLOR}\n"

echo  "db-drop"

NO_DB_CONNECTION_URL=$(sed 's/\/cruddur//g' <<<"$CONNECTION_URL")

psql $NO_DB_CONNECTION_URL -c "drop database cruddur;"
```


**db-schema-load.sh**
```
#! /usr/bin/bash

CYAN='\033[1;36m'
NO_COLOR='\033[0m'
LABEL="db-schema-load"
printf "${CYAN}== ${LABEL}${NO_COLOR}\n"

echo "db schema-load"

schema_path="$(realpath .)/db/schema.sql"
echo $schema_path


if [ "$1" = "prod" ]; then
    echo " This is the production environment."
    URL=$PROD_CONNECTION_URL
else 
    URL=$CONNECTION_URL
fi

psql $URL cruddur < $schema_path
```

                                
**db-seed.sh**
```
#! /usr/bin/bash

CYAN='\033[1;36m'
NO_COLOR='\033[0m'
LABEL="db-seed"
printf "${CYAN}==== ${LABEL}${NO_COLOR}\n"

echo "db seed"

seed_path="$(realpath .)/db/seed.sql"

echo $seed_path

psql $CONNECTION_URL cruddur < $seed_path
```
                                
                                

                                


### 3. Installed Postgres driver in Backend App

### 4. Connected Gitpod IP to RDS Instance

### 5. Create a Cognito Trigger that inserts user into database

### 6. Create new activities with a database insert 
